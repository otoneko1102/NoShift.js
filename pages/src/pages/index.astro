---
import { Icon } from "astro-icon/components";
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import CodeBlock from "../components/CodeBlock.astro";
import { t, type Lang } from "../i18n/translations";
import { links } from "../config/links";
import "../styles/global.css";

const lang: Lang = "en";
---

<BaseLayout lang={lang} title="NoShift.js - Documentation">
  <div class="layout">
    <Sidebar lang={lang} currentPath="/" />
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="mobile-header">
      <button class="hamburger" id="hamburger" aria-label="Toggle menu">
        <Icon name="material-symbols:menu" />
      </button>
      <span class="mobile-title">NoShift.js</span>
    </div>

    <main class="main-content">
      <div class="content home-content">
        <div class="hero">
          <img
            src="/favicon.svg"
            alt="NoShift.js"
            class="hero-icon"
            width="96"
            height="96"
          />
          <h1>NoShift.js</h1>
          <p class="tagline" id="tagline">{t("en", "home.tagline")}</p>
          <p
            class="description"
            id="description"
            set:html={t("en", "home.description")}
          />

          <div class="hero-buttons">
            <a
              href="/en/getting-started/"
              class="btn btn-primary"
              id="btn-get-started"
            >
              {t("en", "home.getStarted")} →
            </a>
            <a
              href={links.github}
              target="_blank"
              rel="noopener"
              class="btn btn-outline"
            >
              {t("en", "home.viewOnGithub")}
            </a>
          </div>
        </div>

        {/* Package Stats */}
        <div class="pkg-stats" id="pkg-stats">
          <div class="stat-item">
            <Icon name="material-symbols:tag" class="stat-icon" />
            <span class="stat-label" id="stat-version-label">
              {t("en", "home.version")}
            </span>
            <span class="stat-value" id="stat-version-value"></span>
          </div>
          <div class="stat-item">
            <Icon name="material-symbols:download" class="stat-icon" />
            <span class="stat-label" id="stat-dl-label">
              {t("en", "home.monthlyDownloads")}
            </span>
            <span class="stat-value" id="stat-dl-value"></span>
          </div>
          <div class="stat-item">
            <Icon
              name="material-symbols:calendar-month-outline"
              class="stat-icon"
            />
            <span class="stat-label" id="stat-pub-label">
              {t("en", "home.lastPublished")}
            </span>
            <span class="stat-value" id="stat-pub-value"></span>
          </div>
        </div>

        {/* Install command */}
        <div class="install-bar">
          <span class="install-label" id="install-label"
            >{t("en", "home.install")}</span
          >
          <div class="install-cmd" id="install-cmd">
            <code>{links.installCmd}</code>
            <button
              class="copy-btn"
              id="copy-btn"
              aria-label="Copy"
              data-copied={t("en", "home.copied")}
            >
              <Icon
                name="material-symbols:content-copy-outline"
                class="copy-icon"
              />
            </button>
          </div>
        </div>

        {/* Links */}
        <div class="link-cards">
          <a
            href={links.github}
            target="_blank"
            rel="noopener"
            class="link-card"
          >
            <Icon name="simple-icons:github" class="link-card-icon" />
            <div class="link-card-body">
              <span class="link-card-title">GitHub</span>
              <span class="link-card-url">otoneko1102/NoShift.js</span>
            </div>
          </a>
          <a href={links.npm} target="_blank" rel="noopener" class="link-card">
            <Icon name="simple-icons:npm" class="link-card-icon" />
            <div class="link-card-body">
              <span class="link-card-title">npm</span>
              <span class="link-card-url">noshift.js</span>
            </div>
          </a>
          <a
            href={links.npmPrettier}
            target="_blank"
            rel="noopener"
            class="link-card"
          >
            <Icon name="simple-icons:prettier" class="link-card-icon" />
            <div class="link-card-body">
              <span class="link-card-title" id="link-prettier-title"
                >Prettier Plugin</span
              >
              <span class="link-card-url">prettier-plugin-noshift.js</span>
            </div>
          </a>
          <a
            href={links.vscodeExtension}
            target="_blank"
            rel="noopener"
            class="link-card"
          >
            <Icon name="simple-icons:visualstudiocode" class="link-card-icon" />
            <div class="link-card-body">
              <span class="link-card-title" id="link-vscode-title"
                >VS Code Extension</span
              >
              <span class="link-card-url">otoneko1102.noshift-vscode</span>
            </div>
          </a>
        </div>

        <div class="features">
          <div class="feature-card">
            <h3 id="feat1-title">{t("en", "home.feature1Title")}</h3>
            <p id="feat1-desc" set:html={t("en", "home.feature1Desc")} />
          </div>
          <div class="feature-card">
            <h3 id="feat2-title">{t("en", "home.feature2Title")}</h3>
            <p id="feat2-desc" set:html={t("en", "home.feature2Desc")} />
          </div>
          <div class="feature-card">
            <h3 id="feat3-title">{t("en", "home.feature3Title")}</h3>
            <p id="feat3-desc" set:html={t("en", "home.feature3Desc")} />
          </div>
        </div>

        <h2 id="example-title">{t("en", "home.quickExample")}</h2>

        <CodeBlock
          lang="nsjs"
          code={`// src/index.nsjs
const name ^- ^2^3no^3shift.js^2;
console.log^8^2^3hello from ^2 ^; name ^; ^2^1^2^9;`}
        />

        <p id="compiles-to">{t("en", "home.compilesTo")}</p>

        <CodeBlock
          lang="javascript"
          code={`const name = "NoShift.js";
console.log("Hello from " + name + "!");`}
        />
      </div>
      <footer class="footer">
        <p>
          MIT License &copy; {new Date().getFullYear()}
          <a href={links.githubAuthor} target="_blank" rel="noopener"
            >otoneko.</a
          >
        </p>
      </footer>
    </main>
  </div>

  <script>
    const hamburger = document.getElementById("hamburger");
    const sidebar = document.querySelector(".sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    hamburger?.addEventListener("click", () => {
      sidebar?.classList.toggle("open");
      overlay?.classList.toggle("open");
    });
    overlay?.addEventListener("click", () => {
      sidebar?.classList.remove("open");
      overlay?.classList.remove("open");
    });

    // Copy button
    const copyBtn = document.getElementById("copy-btn");
    copyBtn?.addEventListener("click", () => {
      navigator.clipboard.writeText("npm install noshift.js").then(() => {
        copyBtn.classList.add("copied");
        setTimeout(() => copyBtn.classList.remove("copied"), 2000);
      });
    });

    // i18n texts
    const i18n: Record<string, Record<string, string>> = {
      en: {
        tagline: "Write JavaScript without pressing the Shift key.",
        description:
          "A joke language that replaces every shift-required symbol with a <code>^</code>-prefixed sequence. <code>.nsjs</code> files compile directly to plain JavaScript via the <code>nsc</code> CLI.",
        "btn-get-started": "Get Started →",
        "feat1-title": "No Shift Required",
        "feat1-desc":
          "All shifted symbols are replaced by simple <code>^</code> + key sequences based on a JIS keyboard layout.",
        "feat2-title": "Instant Compilation",
        "feat2-desc":
          "The <code>nsc</code> CLI compiles <code>.nsjs</code> files to standard JavaScript in milliseconds.",
        "feat3-title": "VS Code Support",
        "feat3-desc":
          "Syntax highlighting and auto-complete via the official VS Code extension.",
        "example-title": "Quick Example",
        "compiles-to": "Compiles to:",
        "install-label": "Install",
        "stat-version-label": "Version",
        "stat-dl-label": "Monthly Downloads",
        "stat-pub-label": "Last Published",
        "link-prettier-title": "Prettier Plugin",
        "link-vscode-title": "VS Code Extension",
        gsHref: "/en/getting-started/",
      },
      ja: {
        tagline: "Shift キーを押さずに JavaScript を書こう。",
        description:
          "Shift が必要な記号を <code>^</code> プレフィックスのシーケンスに置き換える Joke 言語です。<code>.nsjs</code> ファイルは <code>nsc</code> CLI で JavaScript にコンパイルされます。",
        "btn-get-started": "はじめる →",
        "feat1-title": "Shift 不要",
        "feat1-desc":
          "すべての Shift 記号は JIS 配列に基づく <code>^</code> + キーのシーケンスに置き換わります。",
        "feat2-title": "即座にコンパイル",
        "feat2-desc":
          "<code>nsc</code> CLI が <code>.nsjs</code> ファイルをミリ秒で JavaScript にコンパイルします。",
        "feat3-title": "VS Code 対応",
        "feat3-desc":
          "公式の VS Code 拡張機能でシンタックスハイライトと自動補完が利用可能。",
        "example-title": "簡単な例",
        "compiles-to": "コンパイル後:",
        "install-label": "インストール",
        "stat-version-label": "バージョン",
        "stat-dl-label": "月間ダウンロード数",
        "stat-pub-label": "最終公開日",
        "link-prettier-title": "Prettier プラグイン",
        "link-vscode-title": "VS Code 拡張機能",
        gsHref: "/ja/getting-started/",
      },
    };

    function applyLang(lang: string) {
      const texts = i18n[lang];
      if (!texts) return;

      // Update text content
      for (const [id, text] of Object.entries(texts)) {
        if (id === "gsHref") continue;
        const el = document.getElementById(id);
        if (!el) continue;
        if (id.includes("desc") || id === "description") {
          el.innerHTML = text;
        } else {
          el.textContent = text;
        }
      }

      // Update getting-started link
      const gsBtn = document.getElementById(
        "btn-get-started",
      ) as HTMLAnchorElement | null;
      if (gsBtn && texts.gsHref) gsBtn.href = texts.gsHref;

      // Update last published date format
      const pubVal = document.getElementById("stat-pub-value");
      if (pubVal?.dataset.raw) {
        const d = new Date(pubVal.dataset.raw);
        if (!isNaN(d.getTime())) {
          pubVal.textContent = d.toLocaleDateString(
            lang === "ja" ? "ja-JP" : "en-US",
            {
              year: "numeric",
              month: "short",
              day: "numeric",
            },
          );
        }
      }

      // Update sidebar nav links to match language
      document
        .querySelectorAll<HTMLAnchorElement>(
          ".sidebar-nav a[href^='/en/'], .sidebar-nav a[href^='/ja/']",
        )
        .forEach((a) => {
          a.href = a.href.replace(/\/(en|ja)\//, `/${lang}/`);
        });

      // Update lang switcher active state
      document.querySelectorAll(".lang-btn").forEach((btn) => {
        btn.classList.toggle(
          "active",
          btn.textContent?.trim() === lang.toUpperCase(),
        );
      });

      document.documentElement.lang = lang;
    }

    // Language toggle via sidebar lang-switcher
    document.querySelectorAll(".sidebar-footer .lang-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const lang = btn.textContent?.trim().toLowerCase();
        if (lang === "en" || lang === "ja") applyLang(lang);
      });
    });

    // Auto-detect browser language on load
    const currentLang = navigator.language.startsWith("ja") ? "ja" : "en";
    if (currentLang === "ja") {
      applyLang("ja");
    }

    // Fetch npm package stats dynamically
    (async () => {
      try {
        const [pkgRes, dlRes] = await Promise.all([
          fetch("https://registry.npmjs.org/noshift.js"),
          fetch("https://api.npmjs.org/downloads/point/last-month/noshift.js"),
        ]);

        if (pkgRes.ok) {
          const pkg = await pkgRes.json();
          const ver = pkg["dist-tags"]?.latest ?? "";
          if (ver) {
            const versionEl = document.getElementById("stat-version-value");
            if (versionEl) versionEl.textContent = ver;
          }
          const timeStr = pkg.time?.[ver] ?? "";
          if (timeStr) {
            const pubEl = document.getElementById("stat-pub-value");
            if (pubEl) {
              pubEl.dataset.raw = timeStr;
              const lang = document.documentElement.lang || "en";
              pubEl.textContent = new Date(timeStr).toLocaleDateString(
                lang === "ja" ? "ja-JP" : "en-US",
                { year: "numeric", month: "short", day: "numeric" },
              );
            }
          }
        }

        if (dlRes.ok) {
          const dl = await dlRes.json();
          const count = dl.downloads ?? 0;
          const dlEl = document.getElementById("stat-dl-value");
          if (dlEl) dlEl.textContent = count.toLocaleString("en-US");
        }
      } catch (_) {
        /* silently fail */
      }
    })();
  </script>
</BaseLayout>
